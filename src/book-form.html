<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="form-line.html">
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

<dom-module id="book-form">
  <template>

    <style>
      * {
        font-family: 'Roboto', sans-serif;
        color: white;
      }

      #container {
        width: 370px;
        height: 550px;
        background-color: #007936;
        padding: 10px;
      }

      p {
        display: inline-block;
      }

      #addEditButton {
        background-color: rgb(107, 107, 107);
        float: right;
      }

      #addEditButton:hover {
        background-color: #479C5E;
      }
    </style>

    <iron-ajax
      id="addBook"
      url="http://localhost:9999/SogyoLibrary/rest/book"
      content-type="application/json"
      method="POST"
      body={{bookFormInput}}
      handle-as="json"
      on-response="handleResponse">
    </iron-ajax>

    <iron-ajax
      id="editBook"
      url="http://localhost:9999/SogyoLibrary/rest/book"
      content-type="application/json"
      method="PUT"
      body={{bookFormInput}}
      handle-as="json"
      on-response="handleResponse">
    </iron-ajax>

    <div id="container">
      <form-line id="formLineTitle" name="Titel *"></form-line>
      <form-line id="formLineSubtitle" name="Subtitel"></form-line>
      <form-line id="formLineAuthorForename" name="Auteur voornaam *"></form-line>
      <form-line id="formLineAuthorSurname" name="Auteur achternaam *"></form-line>
      <form-line id="formLineCategory" name="Categorie *"></form-line>
      <form-line id="formLinePublisher" name="Uitgever *"></form-line>
      <form-line id="formLineYearFirstPublication" name="Publicatiejaar"></form-line>
      <form-line id="formLineIsbn" name="ISBN *"></form-line>
      <form-line id="formLinePages" name="Bladzijdes"></form-line>
      <form-line id="formLineLanguage" name="Taal"></form-line>
      <p>* verplicht veld</p>

      <paper-button raised id="addEditButton" on-tap="getFormInput">[[buttonText]]</paper-button>
    </div>

  </template>

  <script>
    Polymer({
      is: "book-form",
      properties: {
        bookFormInput: {
          type: Object,
          observer: "setObjectInForm"
        },
        addEditBookMessage: {
          type: Object,
          notify: true
        },
        buttonText: String
      },

      getFormInput: function() {
        var url = document.location.href;
        var urlParts = url.split('/');
        var lastUrlPart = urlParts.pop();
        if (!/^\d+$/.test(lastUrlPart)) {
          lastUrlPart = 0;
        }
        this.bookFormInput = {
          id: lastUrlPart,
          title: this.$.formLineTitle.getInputValue(),
          subtitle: this.$.formLineSubtitle.getInputValue(),
          authorForename: this.$.formLineAuthorForename.getInputValue(),
          authorSurname: this.$.formLineAuthorSurname.getInputValue(),
          category: this.$.formLineCategory.getInputValue(),
          publisher: this.$.formLinePublisher.getInputValue(),
          yearFirstPublication: this.$.formLineYearFirstPublication.getInputValue(),
          isbn: this.$.formLineIsbn.getInputValue(),
          pages: this.$.formLinePages.getInputValue(),
          language: this.$.formLineLanguage.getInputValue()
        };
        this.validateInput();
      },

      handleResponse: function(data) {
        this.addEditBookMessage = data.detail.response;
      },

      validateInput: function() {
        var validateMessage = {commandSucceeded: false, message: ""};
        if (this.bookFormInput.title === "") {
          validateMessage.message = "Vul een titel in";
        } else if (this.bookFormInput.authorForename === "") {
          validateMessage.message = "Vul een voornaam in";
        } else if (this.bookFormInput.authorSurname === "") {
          validateMessage.message = "Vul een achternaam in";
        } else if (this.bookFormInput.category === "") {
          validateMessage.message = "Vul een categorie in";
        } else if (this.bookFormInput.publisher === "") {
          validateMessage.message = "Vul een uitgever in";
        } else if (this.bookFormInput.isbn === "") {
          validateMessage.message = "Vul een ISBN in";
        } else if (this.isbnIsNotValid(this.bookFormInput.isbn)) {
          validateMessage.message = "Opgegeven ISBN is onjuist";
        } else {
          validateMessage.commandSucceeded = true;
        }

        if (validateMessage.commandSucceeded) {
          if (this.buttonText === "Toevoegen") {
            this.$.addBook.generateRequest();
          } else {
            this.$.editBook.generateRequest();
          }
        } else {
          this.addEditBookMessage = validateMessage;
        }
      },

      isbnIsNotValid: function(isbn) {
        if (isbn.length !== 13) {
          return true;
        } else if (isbn.substring(0, 3) !== "978" && isbn.substring(0, 3) !== "979") {
          return true;
        } else if (this.calculateCheckDigitISBN(isbn) !== Number(isbn.charAt(12))) {
          return true;
        } else {
          return false;
        }
      },

      calculateCheckDigitISBN: function(isbn) {
        var checkDigit = Math.abs(((Number(isbn.charAt(1)) + Number(isbn.charAt(3))
        + Number(isbn.charAt(5)) + Number(isbn.charAt(7))
        + Number(isbn.charAt(9)) + Number(isbn.charAt(11))) * 3
        + Number(isbn.charAt(0)) + Number(isbn.charAt(2))
        + Number(isbn.charAt(4)) + Number(isbn.charAt(6))
        + Number(isbn.charAt(8)) + Number(isbn.charAt(10)))
        % 10 - 10);

        if (checkDigit == 10) {
          checkDigit = 0;
        }
        return checkDigit;
      },

      setObjectInForm: function() {
        this.$.formLineTitle.inputValue = this.bookFormInput.title;
        this.$.formLineSubtitle.inputValue = this.bookFormInput.subtitle;
        this.$.formLineAuthorForename.inputValue = this.bookFormInput.authorForename;
        this.$.formLineAuthorSurname.inputValue = this.bookFormInput.authorSurname;
        this.$.formLineCategory.inputValue = this.bookFormInput.category;
        this.$.formLinePublisher.inputValue = this.bookFormInput.publisher;
        this.$.formLineYearFirstPublication.inputValue = this.bookFormInput.yearFirstPublication;
        this.$.formLineIsbn.inputValue = this.bookFormInput.isbn;
        this.$.formLinePages.inputValue = this.bookFormInput.pages;
        this.$.formLineLanguage.inputValue = this.bookFormInput.language;
      }
    });
  </script>

</dom-module>
