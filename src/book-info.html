<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="token-ajax.html">

<dom-module id="book-info">
  <template>

    <style>
      #containerMessage {
        color: red;
      }

      paper-button {
        color: white;
        background-color: #007936;
      }

      #copiesAvailableContainer {
        display: inline;
      }
    </style>

    <table>
      <tr>
        <th>Titel</th>
        <td id="title">{{bookInfo.book.title}}</td>
      </tr>
      <tr>
        <th>Subtitel</th>
        <td id="subtitle">{{bookInfo.book.subtitle}}</td>
      </tr>
      <tr>
        <th id="authorsTitle">{{authorsTitle}}</th>
        <td id="authors">{{authors}}</td>
      </tr>
      <tr>
        <th>Categorie</th>
        <td id="category">{{bookInfo.book.category.name}}</td>
      </tr>
      <tr>
        <th>Uitgever</th>
        <td id="publisher">{{bookInfo.book.publisher.name}}</td>
      </tr>
      <tr>
        <th>Publicatiejaar</th>
        <td id="yearFirstPublication">{{bookInfo.book.yearFirstPublication}}</td>
      </tr>
      <tr>
        <th>ISBN</th>
        <td id="isbn">{{bookInfo.book.isbn}}</td>
      </tr>
      <tr>
        <th>Bladzijdes</th>
        <td id="pages">{{bookInfo.book.pages}}</td>
      </tr>
      <tr>
        <th>Taal</th>
        <td id="language">{{bookInfo.book.language}}</td>
      </tr>
    </table>

    <h4 id="copiesAvailableContainer">Beschikbaar: <span id="copiesavailable">{{copiesAvailable}}</span></h4>
    <paper-button raised id="plus-button" on-tap="addCopy">+</paper-button>
    <paper-button raised id="minus-button" on-tap="deleteCopy">-</paper-button>
    <h4>Uitgeleend: 0</h4>

    <paper-button raised id="edit-book-button" on-tap="goToEditBook">Boek wijzigen</paper-button>
    <paper-button raised id="delete-book-button" on-tap="deleteBook">Boek verwijderen</paper-button>

    <h4 id="containerMessage">{{message}}</h4>

    <token-ajax
      id="requestBookInfo"
      path="book/{{bookId}}"
      method="GET"
      response-data={{bookInfo}}>
    </token-ajax>

    <token-ajax
      id="addCopy"
      path="book/{{bookId}}/copy"
      method="POST"
      response-data={{copyMessage}}>
    </token-ajax>

    <token-ajax
      id="deleteCopy"
      path="book/{{bookId}}/copy"
      method="DELETE"
      response-data={{copyMessage}}>
    </token-ajax>

    <token-ajax
      id="deleteBook"
      path="book/{{bookId}}"
      method="DELETE"
      response-data={{deleteBookMessage}}>
    </token-ajax>
  </template>

  <script>
    Polymer({
      is: "book-info",
      properties: {
        bookId: Number,
        bookInfo: {
          type: Object,
          observer: "handleBookInfoResponse"
        },
        copyMessage: {
          type: Object,
          observer: "handleCopyResponse"
        },
        deleteBookMessage: {
          type: Object,
          observer: "handleDeleteBookResponse"
        },
        message: String,
        copiesAvailable: Number,
        authorsTitle: {
          type: String,
          value: "Auteur"
        },
        authors: String
      },

      ready: function() {
        var url = document.location.href;
        var urlParts = url.split('/');
        var lastUrlPart = urlParts.pop();
        if (lastUrlPart === "addsuccessful") {
          this.message = "Boek succesvol toegevoegd";
          this.bookId = urlParts.pop();
        } else if (lastUrlPart === "editsuccessful") {
          this.message = "Boek succesvol aangepast";
          this.bookId = urlParts.pop();
        } else {
          this.bookId = lastUrlPart;
        }
        this.$.requestBookInfo.generateRequest();
      },

      handleBookInfoResponse: function() {
        this.copiesAvailable = this.bookInfo.copiesAvailable;
        this.authors = (this.bookInfo.book.authors[0].forename + " " + this.bookInfo.book.authors[0].surname);

        if (this.bookInfo.book.authors.length >= 2) {
          this.authorsTitle += "s";
          this.authors += (", " + this.bookInfo.book.authors[1].forename + " " + this.bookInfo.book.authors[1].surname);
        }

        if (this.bookInfo.book.authors.length === 3) {
          this.authors += (", " + this.bookInfo.book.authors[2].forename + " " + this.bookInfo.book.authors[2].surname);
        }
      },

      handleCopyResponse: function() {
        console.log(this.copyMessage);
        if (this.copyMessage.commandSucceeded) {
          this.copiesAvailable = this.copyMessage.copiesOfBook;
        }
        this.message = this.copyMessage.message;
      },

      handleDeleteBookResponse: function() {
        if (this.deleteBookMessage.commandSucceeded) {
          window.location.href = "search-book/deletesuccessful";
        } else {
          this.message = this.deleteBookMessage.message;
        }
      },

      addCopy: function() {
        this.$.addCopy.generateRequest();
      },

      deleteCopy: function() {
        console.log(this.copiesAvailable);
        if (this.copiesAvailable > 0) {
          this.$.deleteCopy.generateRequest();
        }
      },

      goToEditBook: function() {
        window.location.href = `edit-book/${this.bookId}`;
      },

      deleteBook: function() {
        this.$.deleteBook.generateRequest();
      }
    });
  </script>
</dom-module>
