<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<dom-module id="book-info">
  <template>

    <style>
      #containerMessage {
        color: red;
      }

      paper-button {
        color: white;
        background-color: #007936;
      }

      #copiesAvailableContainer {
        display: inline;
      }
    </style>

    <table>
      <tr>
        <th>Titel</th>
        <td id="title">{{bookInfo.book.title}}</td>
      </tr>
      <tr>
        <th>Subtitel</th>
        <td id="subtitle">{{bookInfo.book.subtitle}}</td>
      </tr>
      <tr>
        <th id="authorsTitle">Auteur</th>
        <td id="authors">{{bookInfo.book.authorForename}} {{bookInfo.book.authorSurname}}</td>
      </tr>
      <tr>
        <th>Categorie</th>
        <td id="category">{{bookInfo.book.category.name}}</td>
      </tr>
      <tr>
        <th>Uitgever</th>
        <td id="publisher">{{bookInfo.book.publisher.name}}</td>
      </tr>
      <tr>
        <th>Publicatiejaar</th>
        <td id="yearFirstPublication">{{bookInfo.book.yearFirstPublication}}</td>
      </tr>
      <tr>
        <th>ISBN</th>
        <td id="isbn">{{bookInfo.book.isbn}}</td>
      </tr>
      <tr>
        <th>Bladzijdes</th>
        <td id="pages">{{bookInfo.book.pages}}</td>
      </tr>
      <tr>
        <th>Taal</th>
        <td id="language">{{bookInfo.book.language}}</td>
      </tr>
    </table>

    <h4 id="copiesAvailableContainer">Beschikbaar: <span id="copiesavailable">{{bookInfo.copiesAvailable}}</span></h4>
    <paper-button raised id="plus-button" on-tap="addCopy">+</paper-button>
    <paper-button raised id="minus-button" on-tap="deleteCopy">-</paper-button>
    <h4>Uitgeleend: 0</h4>

    <paper-button raised id="edit-book-button" on-tap="goToEditBook">Boek wijzigen</paper-button>
    <paper-button raised id="delete-book-button" on-tap="deleteBook">Boek verwijderen</paper-button>

    <h4 id="containerMessage"></h4>

    <iron-ajax
      id="requestBookInfo"
      url="http://localhost:9999/SogyoLibrary/rest/book/{{bookId}}"
      method="GET"
      handle-as="json"
      on-response="handleBookInfoResponse">
    </iron-ajax>

    <iron-ajax
      id="addCopy"
      url="http://localhost:9999/SogyoLibrary/rest/book/{{bookId}}/copy"
      method="POST"
      handle-as="json"
      on-response="handleCopyResponse">
    </iron-ajax>

    <iron-ajax
      id="deleteCopy"
      url="http://localhost:9999/SogyoLibrary/rest/book/{{bookId}}/copy"
      method="DELETE"
      handle-as="json"
      on-response="handleCopyResponse">
    </iron-ajax>

    <iron-ajax
      id="deleteBook"
      url="http://localhost:9999/SogyoLibrary/rest/book/{{bookId}}"
      method="DELETE"
      handle-as="json"
      on-response="handleDeleteBookResponse">
    </iron-ajax>
  </template>

  <script>
    Polymer({
      is: "book-info",
      properties: {
        bookId: Number,
        bookInfo: Object
      },

      ready: function() {
        var url = document.location.href;
        var urlParts = url.split('/');
        var lastUrlPart = urlParts.pop();
        if (lastUrlPart === "addsuccessful") {
          this.$.containerMessage.innerHTML = "Boek succesvol toegevoegd";
          this.bookId = urlParts.pop();
        } else if (lastUrlPart === "editsuccessful") {
          this.$.containerMessage.innerHTML = "Boek succesvol aangepast";
          this.bookId = urlParts.pop();
        } else {
          this.bookId = lastUrlPart;
        }
        this.$.requestBookInfo.generateRequest();
      },

      handleBookInfoResponse: function(data) {
        this.bookInfo = data.detail.response;
        this.$.authors.innerHTML = (this.bookInfo.book.authors[0].forename + " " + this.bookInfo.book.authors[0].surname);

        if (this.bookInfo.book.authors.length >= 2) {
          this.$.authorsTitle.innerHTML += "s";
          this.$.authors.innerHTML += (", " + this.bookInfo.book.authors[1].forename + " " + this.bookInfo.book.authors[1].surname);
        }

        if (this.bookInfo.book.authors.length === 3) {
          this.$.authors.innerHTML += (", " + this.bookInfo.book.authors[2].forename + " " + this.bookInfo.book.authors[2].surname);
        }
      },

      handleCopyResponse: function(data) {
        var copyMessage = data.detail.response;
        if (copyMessage.commandSucceeded) {
          this.bookInfo.copiesAvailable = copyMessage.copiesOfBook;
          this.$.copiesavailable.innerHTML = copyMessage.copiesOfBook;
        }
        this.$.containerMessage.innerHTML = copyMessage.message;
      },

      handleDeleteBookResponse: function(data) {
        var deleteBookMessage = data.detail.response;
        if (deleteBookMessage.commandSucceeded) {
          window.location.href = "search-book/deletesuccessful";
        } else {
          this.$.containerMessage.innerHTML = deleteBookMessage.message;
        }
      },

      addCopy: function() {
        this.$.addCopy.generateRequest();
      },

      deleteCopy: function() {
        if (this.bookInfo.copiesAvailable > 0) {
          this.$.deleteCopy.generateRequest();
        }
      },

      goToEditBook: function() {
        window.location.href = "edit-book/" + this.bookId;
      },

      deleteBook: function() {
        this.$.deleteBook.generateRequest();
      }
    });
  </script>
</dom-module>
